<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>PubNub Demo</title>

    <!-- Bootstrap -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/c3/0.4.10/c3.min.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <style>

        .large_map {
            width: 100%;
            height: 500px;
            text-align: center;
        }


    </style>
</head>
<body>
<nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="#">Pub Nub Demo</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">

        </div><!--/.navbar-collapse -->
    </div>
</nav>

<!-- Main jumbotron for a primary marketing message or call to action -->
<div class="jumbotron">
    <div class="container">
        <h1>Javascript Everywhere?</h1>
        <p>Where do the tweets about #javascript come from?</p>
    </div>
</div>

<div class="container">
    <div class="row">
        <div class="col-lg-4 col-md-4">
            <p>Javascript</p>
            <div id="javascriptGraph"></div>
        </div>
        <div class="col-lg-4 col-md-4">
            <p>PubNub</p>
            <div id="pubnubGraph"></div>
        </div>
        <div class="col-lg-4 col-md-4">
            <p>Trends</p>
            <div id="trendGraph"></div>
        </div>
    </div>

    <hr>

    <footer>
        <p>&copy; 2016 Joel Lord - <a href="http://joel.lord.rocks">http://joel.lord.rocks</a></p>
        <p>Trend data comes from <a href="http://api.whatthetrend.com/" target="_blank">
            <img src="http://api.whatthetrend.com/images/wtt_api_badge_120.png" border="0">
        </a></p>
    </footer>
</div> <!-- /container -->

<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
<!-- Include the PubNub script -->
<script src="http://cdn.pubnub.com/pubnub.min.js"></script>

<!-- Graph Stuff -->
<script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.5.3/d3.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/c3/0.4.10/c3.min.js"></script>

<script type="text/javascript">
var MAX_DATASET_LENGTH = 250;
var DEBOUNCE_TIME = 1000;
//Yay !  JS !
window.onload = function() {
    var pubnub = PUBNUB.init({
        subscribe_key: 'sub-c-67f63a44-ba40-11e5-8b32-02ee2ddab7fe'
    });

    var datasets = {
        javascript: ["javascript", 0],
        pubnub: ["pubnub", 0],
        trend: {}
    };

    pubnub.subscribe({
        channel: 'javascript',
        message: function(m){
            var lastVal = datasets.javascript[datasets.javascript.length-1];
            datasets.javascript.push(lastVal+m);
            javascriptGraph.load({
                columns: [
                    datasets.javascript
                ]
            });
        }
    });

    pubnub.subscribe({
        channel: 'pubnub',
        message: function(m){
            var lastVal = datasets.pubnub[datasets.pubnub.length-1];
            datasets.pubnub.push(lastVal+m);
            pubnubGraph.load({
                columns: [
                    datasets.pubnub
                ]
            });
        }
    });

    pubnub.subscribe({
        channel: 'trend',
        message: function(m){
            if (!datasets.trend[m.keyword]) datasets.trend[m.keyword] = [0];
            var lastVal = datasets.trend[m.keyword][datasets.trend[m.keyword].length-1];
            datasets.trend[m.keyword].push(lastVal+ m.score);
        }
    });

    setInterval(function() {
        var columns = [];
        for (var keyword in datasets.trend) {
            var tooMany = datasets.trend[keyword].length - MAX_DATASET_LENGTH;
            if (tooMany < 0) tooMany = 0;
            datasets.trend[keyword].splice(0, tooMany);
            columns.push([keyword].concat(datasets.trend[keyword]));
        }
        trendGraph.load({
            columns: columns
        });
    }, DEBOUNCE_TIME);

    var javascriptGraph = c3.generate({
        bindto: '#javascriptGraph',
        data: {
            columns: [
                datasets.javascript
            ]
        }
    });

    var pubnubGraph = c3.generate({
        bindto: '#pubnubGraph',
        data: {
            columns: [
                datasets.pubnub
            ]
        }
    });

    var trendGraph = c3.generate({
        bindto: '#trendGraph',
        data: {
            columns: [

            ]
        }
    });

};
</script>
</body>
</html>